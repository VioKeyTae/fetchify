<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ApiTester</title>
</head>

<body>

  <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="scripts/ApiRequester.js"></script>
  <link rel="stylesheet" href="css/style.min.css">
  <script type="text/javascript">
    let apiRequester = new ApiRequester("https://api.spotify.com", "BQBbVQ1s1nlLGZO5gxcNi0OT6WuDDfGDYy41oimJo3ilsRpAmPS9nGxAhKXZ5UlaWYLYa6SqauUA-RIYxlBIMFsD0Qs2yErOrI9qQLFaV8o7JKwtCQ8Y69cTBoLhEu3_hWBNPQR4D6RUu9OTFCJLv2B5x-nclUxmQg");
    /*apiRequester.getArtist("Bebe", function(data) {
      //console.log(data);
    });

    apiRequester.getTopTracks("64M6ah0SkkRsnPGtGiRAbb", function(data) {
      //console.log(data);
    });

    apiRequester.getSongData("7iDa6hUg2VgEL1o1HjmfBn", function(data) {
      //console.log(data);
    })
    */
  </script>
  <header>
    <h1>Fancy Headline</h1>
    <p class="desc">Finde heraus welche Songs am besten zu dir passen. Suche jetzt nach einem Künstler um die verschiedensten Eigenschaften der Musik vergleichen zu können.</p>
  <div class="search">
    <input type="text" id="artistsearch" class="artistsearch" placeholder="type Artist here">
    <div id="suggestion"></div>
  </div>
  </header>

  <div id="chooseSong">
  </div>
  <div class="preview">
    <video id="audio" controls="" name="media">
      <source id="preview_source" src="" type="audio/mpeg">
    </video>
  </div>
  <div class="data">
    DATASTUFF
  </div>



</body>
<script type="text/javascript">
  let searchstring = "";
  let timer;
  let data;

  document.getElementById('artistsearch').addEventListener('input', function(e) {
    clearTimeout(timer);
    timer = setTimeout(() => {
      getArtistData(this.value);
    }, 1000);
  });

  function getArtistData(val) {
    searchstring = val;
    apiRequester.getArtist(searchstring, function(data) {
      this.data = data;
      document.querySelector('#suggestion').innerHTML="";
      this.data.artists.items.forEach(function(item) {
        console.log(item.name);
        let artist = document.createElement('a');
        artist.innerHTML = item.name;

        artist.addEventListener('click', ()=>{
          document.querySelector('#artistsearch').value = item.name;
          document.querySelector('#suggestion').innerHTML = "";
          returnSuggestion(item.id);
        });
        document.querySelector('#suggestion').append(artist);
      });
    //  artist = this.data.artists.items[0].id;

    });
  }
  function returnSuggestion(artistId){
     getTopTracksData(artistId);
  }
  let songs;
  function getTopTracksData(id) {
    apiRequester.getTopTracks(id, function(data) {
      let buttondiv  = document.querySelector('#chooseSong');
      buttondiv.innerHTML = "";
      data.forEach(function(item, i) {
        let song = document.createElement('div');
        let songlink = document.createElement('a');
        songlink.addEventListener('click', ()=>{
          document.querySelector('#preview_source').style.display = "flex";
          document.querySelector('#preview_source').src = data[i].preview_url;
          let audio = document.querySelector('#audio');
          audio.load();
          console.log(data.preview_url);
        });
        songlink.innerHTML = item.name;
        songlink.classList.add("song");
        song.append(songlink);
        song.classList.add('songbutton');
        buttondiv.append(song);
      });
  	  songs = document.querySelectorAll('.song');

      //SHITTY SCROLLING IS SHITTY
      for(let i = 0; i<songs.length; i++){
        if(isOverflown(songs[i])){
          setInterval(() => {
            let a = false;
              if(songs[i].clientWidth+songs[i].scrollLeft>=songs[i].scrollWidth&&a==false){
                  a = true;
                  setTimeout(()=>{
                    songs[i].scrollLeft = 0;
                    a = false;
                  }, 2000);
              }
              else if(a == false){
                songs[i].scrollBy(1,0);
              }
          }, 25);
        }
      }
    });
  }

  function isOverflown(element) {
    return element.scrollHeight > element.clientHeight || element.scrollWidth > element.clientWidth;
  }
</script>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

<script src="scripts/draw.js" ></script>

</html>
